---
title: "ttTi5605 methylation analysis"
author: "Jennifer Semple"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette ttTi5605 methylation analysis }
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  echo = TRUE
)
```

## Choosing log likelihood cutoff values

The data shown are generated by calling methylation on nanopore reads using nanopolish. This output two .tsv files, one has frequency of methylation, the other has single molecule data. Here an example of part of the single molecule data

```{r}
library(nanodsmf)
library(magrittr)
library(ggplot2)

knitr::kable(head(MSssI_CpG),full_width=F)
```


The Nanopolish calculate methylation frequency script (https://github.com/jts/nanopolish/blob/master/scripts/calculate_methylation_frequency.py) sets positive log_lik_ratio > 0 to methylated, but excludes all positions with an absolute value of log_like_ratio < 2.5. To test how this works on my data i will plot histograms with the different datasets. The cutoff is show in red.


```{r, fig.show='hold'}

ggplot(MSssI_CpG,aes(x=log_lik_ratio)) +
  geom_histogram(bins=100) + xlim(-15,15) + ggtitle("MSssI_CpG") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(MSssI_GpC,aes(x=log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("MSssI_GpC") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(MCviPI_CpG,aes(x=log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("MCviPI_CpG") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(MCviPI_GpC,aes(x=log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("MCviPI_GpC") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(Control_CpG,aes(x=log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("Control_CpG") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(Control_GpC,aes(x=log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("Control_GpC") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 
```

Comparing the control to the methylated samples, 2.5 is probably an appropriate cutoff.

## Does number of motifs affect the log_lik_ratio

```{r, fig.show='hold'}

ggplot(MSssI_CpG, aes(x=as.factor(num_motifs),y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MSssI_CpG") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")


ggplot(MSssI_GpC, aes(x=as.factor(num_motifs), y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MSssI_GpC") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(MCviPI_CpG, aes(x=as.factor(num_motifs), y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MCviPI_CpG") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(MCviPI_GpC, aes(x=as.factor(num_motifs), y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MCviPI_GpC") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(Control_CpG, aes(x=as.factor(num_motifs), y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("Control_CpG") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(Control_GpC, aes(x=as.factor(num_motifs), y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("Control_GpC") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

```

There is a clear increase in log likelihood when more site are present in samples that have been methylated on that motif, and a clear reduction of log likelihood when more sites are present in samples not methylated on that motif. Should some normalisation by the number of motifs should be carried out.

## Normalising log_lik_ratio by number of motifs

```{r, fig.show='hold'}

#normalise all log_lik_ratio by number of motifs
MSssI_CpG$norm_log_lik_ratio<-MSssI_CpG$log_lik_ratio/MSssI_CpG$num_motifs
MSssI_GpC$norm_log_lik_ratio<-MSssI_GpC$log_lik_ratio/MSssI_GpC$num_motifs
MCviPI_CpG$norm_log_lik_ratio<-MCviPI_CpG$log_lik_ratio/MCviPI_CpG$num_motifs
MCviPI_GpC$norm_log_lik_ratio<-MCviPI_GpC$log_lik_ratio/MCviPI_GpC$num_motifs
Control_CpG$norm_log_lik_ratio<-Control_CpG$log_lik_ratio/Control_CpG$num_motifs
Control_GpC$norm_log_lik_ratio<-Control_GpC$log_lik_ratio/Control_GpC$num_motifs


ggplot(MSssI_CpG, aes(x=as.factor(num_motifs), y=norm_log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MSssI_CpG") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")


ggplot(MSssI_GpC, aes(x=as.factor(num_motifs),y=norm_log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MSssI_GpC") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(MCviPI_CpG, aes(x=as.factor(num_motifs), y=norm_log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MCviPI_CpG") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(MCviPI_GpC, aes(x=as.factor(num_motifs), y=norm_log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MCviPI_GpC") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(Control_CpG, aes(x=as.factor(num_motifs), y=norm_log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("Control_CpG") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(Control_GpC, aes(x=as.factor(num_motifs), y=norm_log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("Control_GpC") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

```

The boxplots show that normalising by the number of motifs serves to make the log likelihood distribution more similar. Therefore this would be a good strategy when splitting apart separate sites - can simply divide the log likelihood between the sites. 

This also makes sense in terms of combined probabilities: A joint probability of independent events would be a multiplication of the individual probabilities and therefore an addition of the logs of the probabilities/likelihoods. If we were to simply assign the fragment probability to each of the constituent sites, that would inflate the methyltion score. 

Note that the Nanopolish scripts to calculate methylation frequency first binarises methylation status and then passes this to the sub-sites when "split" is turned on.


```{r, fig.show='hold'}


ggplot(MSssI_CpG,aes(x=norm_log_lik_ratio)) +
  geom_histogram(bins=100) + xlim(-15,15) + ggtitle("MSssI_CpG") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(MSssI_GpC,aes(x=norm_log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("MSssI_GpC") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(MCviPI_CpG,aes(x=norm_log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("MCviPI_CpG") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(MCviPI_GpC,aes(x=norm_log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("MCviPI_GpC") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(Control_CpG,aes(x=norm_log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("Control_CpG") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(Control_GpC,aes(x=norm_log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("Control_GpC") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

```

This change does not seem to significantly change the distribution of the values and $abs(norm\_log\_lik\_ratio) > 2.5$ is probably still a good threshold.

## Plotting split motifs

The function *splitMotifs()* changes the tsv to contain exact start and end of the CG or GC motif (rather than of the whole sequence fragment surrounding it). For sequences taht contain more than one motif of a particular types, these will be split into multiple rows, with each row containing the exact start and end of the motif, and the log_lik_ratio normalised by the number of motifs in the sequence. The "sequence" and "motif_num" fields are not modified.

```{r, fig.show='hold'}

#split mutli-motif fragments and normalise log_lik_ratio
MSssI_CpG<-splitMotifs(MSssI_CpG,"CG")
MSssI_GpC<-splitMotifs(MSssI_GpC,"GC")
MCviPI_CpG<-splitMotifs(MCviPI_CpG,"CG")
MCviPI_GpC<-splitMotifs(MCviPI_GpC,"GC")
Control_CpG<-splitMotifs(Control_CpG,"CG")
Control_GpC<-splitMotifs(Control_GpC,"GC")


ggplot(MSssI_CpG, aes(x=as.factor(num_motifs),y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MSssI_CpG") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")


ggplot(MSssI_GpC, aes(x=as.factor(num_motifs), y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MSssI_GpC") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(MCviPI_CpG, aes(x=as.factor(num_motifs), y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MCviPI_CpG") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(MCviPI_GpC, aes(x=as.factor(num_motifs), y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("MCviPI_GpC") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(Control_CpG, aes(x=as.factor(num_motifs), y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("Control_CpG") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

ggplot(Control_GpC, aes(x=as.factor(num_motifs), y=log_lik_ratio, group=as.factor(num_motifs), fill=as.factor(num_motifs))) +
  geom_boxplot() + ggtitle("Control_GpC") + scale_fill_brewer(palette="Dark2",name="motifs") +
  xlab("num_motifs")

```



```{r, fig.show='hold'}

ggplot(MSssI_CpG,aes(x=log_lik_ratio)) +
  geom_histogram(bins=100) + xlim(-15,15) + ggtitle("MSssI_CpG") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(MSssI_GpC,aes(x=log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("MSssI_GpC") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(MCviPI_CpG,aes(x=log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("MCviPI_CpG") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(MCviPI_GpC,aes(x=log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("MCviPI_GpC") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(Control_CpG,aes(x=log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("Control_CpG") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 

ggplot(Control_GpC,aes(x=log_lik_ratio))+
  geom_histogram(bins=100)+ xlim(-15,15) + ggtitle("Control_GpC") +
  geom_vline(xintercept = c(-2.5,2.5), linetype="dashed", color = "red", size=1) 
```


## Creating a methylation matrix based on genomic ranges

Since the ttTi5605 PCR fragment is only 2.3 kb long we will create a matrix over the whole region.


```{r}
#freq<-MSssI_CpG %>%
#  dplyr::group_by(read_name) %>%
#  dplyr::summarise(freqMeth=mean(methylated,na.rm=T),count=n())
```



